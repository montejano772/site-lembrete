<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Transcri√ß√£o de Voz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
      }

      body {
        background: #0f172a;
        color: #e5e7eb;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .app {
        width: 100%;
        max-width: 520px;
        background: #020617;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        border: 1px solid #1f2937;
      }

      h1 {
        font-size: 1.4rem;
        margin-bottom: 6px;
      }

      .sub {
        font-size: 0.9rem;
        color: #9ca3af;
        margin-bottom: 16px;
      }

      .status {
        font-size: 0.85rem;
        margin-bottom: 10px;
      }

      .status-idle {
        color: #9ca3af;
      }

      .status-listening {
        color: #22c55e;
      }

      .status-error {
        color: #f97316;
      }

      .buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      button {
        flex: 1 1 calc(50% - 8px);
        padding: 10px;
        border-radius: 999px;
        border: none;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
      }

      #btnStart {
        background: #22c55e;
        color: #022c22;
      }

      #btnStop {
        background: #ef4444;
        color: #fef2f2;
      }

      #btnClear {
        background: #0ea5e9;
        color: #e0f2fe;
      }

      #btnSendWhats {
        background: #25d366;
        color: #022c22;
      }

      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      textarea {
        width: 100%;
        min-height: 240px;
        resize: vertical;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid #1f2937;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.95rem;
      }

      .helper {
        font-size: 0.8rem;
        color: #9ca3af;
        margin-top: 8px;
      }

      .warn {
        margin-top: 12px;
        font-size: 0.85rem;
        color: #f97316;
      }
    </style>
  </head>

  <body>
    <div class="app">
      <h1>Transcri√ß√£o de Voz</h1>
      <p class="sub">Fale e veja o texto aparecer automaticamente.</p>

      <div class="status" id="status">
        Status: <span class="status-idle">Parado</span>
      </div>

      <div class="buttons">
        <button id="btnStart">Iniciar</button>
        <button id="btnStop" disabled>Parar</button>
        <button id="btnClear">Limpar</button>
        <button id="btnSendWhats">Enviar WhatsApp</button>
      </div>

      <textarea
        id="output"
        placeholder="O texto da sua fala aparecer√° aqui..."
      ></textarea>

      <p class="helper">
        Dica: fale pausado. Depois organize o texto e envie pro WhatsApp.
      </p>

      <p class="warn" id="warning"></p>
    </div>

    <script>
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      const statusEl = document.getElementById("status");
      const warningEl = document.getElementById("warning");
      const outputEl = document.getElementById("output");
      const btnStart = document.getElementById("btnStart");
      const btnStop = document.getElementById("btnStop");
      const btnClear = document.getElementById("btnClear");
      const btnSendWhats = document.getElementById("btnSendWhats");

      let recognition = null;
      let finalTranscript = "";
      let lastFinalAdded = "";
      let isRecording = false;

      // Remove sobreposi√ß√£o t√≠pica do Chrome Android
      function removeOverlap(prev, next) {
        prev = (prev || "").trim();
        next = (next || "").trim();
        if (!prev || !next) return next;

        const max = Math.min(prev.length, next.length);
        for (let size = max; size >= 10; size--) {
          const suffix = prev.slice(-size);
          const prefix = next.slice(0, size);
          if (suffix === prefix) {
            return next.slice(size).trim();
          }
        }
        return next;
      }

      if (!SpeechRecognition) {
        warningEl.textContent =
          "Seu navegador n√£o suporta reconhecimento de voz. Use Chrome ou Edge.";
        btnStart.disabled = true;
        btnStop.disabled = true;
      } else {
        recognition = new SpeechRecognition();
        recognition.lang = "pt-BR";
        recognition.continuous = false; // essencial no Android
        recognition.interimResults = true;
        recognition.maxAlternatives = 1;

        recognition.onresult = (event) => {
          let interim = "";

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const r = event.results[i];
            const raw = r[0].transcript || "";
            const text = raw.trim();
            if (!text) continue;

            if (r.isFinal) {
              if (text === lastFinalAdded) continue;

              const toAdd = removeOverlap(finalTranscript, text);
              if (toAdd) {
                finalTranscript = (finalTranscript + " " + toAdd).trim();
              }
              lastFinalAdded = text;
            } else {
              interim += raw;
            }
          }

          outputEl.value = (finalTranscript + " " + interim).trim();
        };

        recognition.onerror = (event) => {
          statusEl.innerHTML =
            'Status: <span class="status-error">Erro: ' +
            event.error +
            "</span>";
        };

        recognition.onend = () => {
          if (isRecording) {
            try {
              recognition.start();
              statusEl.innerHTML =
                'Status: <span class="status-listening">Ouvindo...</span>';
              return;
            } catch {}
          }

          btnStart.disabled = false;
          btnStop.disabled = true;
          statusEl.innerHTML =
            'Status: <span class="status-idle">Parado</span>';
        };
      }

      btnStart.addEventListener("click", () => {
        if (!recognition) return;

        warningEl.textContent = "";
        isRecording = true;

        try {
          recognition.start();
          btnStart.disabled = true;
          btnStop.disabled = false;
          statusEl.innerHTML =
            'Status: <span class="status-listening">Ouvindo...</span>';
        } catch (e) {
          console.error(e);
        }
      });

      btnStop.addEventListener("click", () => {
        if (!recognition) return;

        isRecording = false;
        try {
          recognition.stop();
        } catch {}

        btnStart.disabled = false;
        btnStop.disabled = true;
        statusEl.innerHTML = 'Status: <span class="status-idle">Parado</span>';
      });

      // üßπ LIMPAR
      btnClear.addEventListener("click", () => {
        finalTranscript = "";
        lastFinalAdded = "";
        outputEl.value = "";
        warningEl.textContent = "";
      });

      btnSendWhats.addEventListener("click", () => {
        const text = outputEl.value.trim();
        if (!text) {
          warningEl.textContent = "Digite ou grave algo para enviar.";
          return;
        }

        let number = prompt(
          "Digite o n√∫mero de WhatsApp COM DDD (apenas n√∫meros):",
        );
        if (!number) return;

        number = number.replace(/\D/g, "");
        if (!number.startsWith("55")) number = "55" + number;

        const maxChars = 1500;
        const sendText =
          text.length > maxChars ? text.slice(0, maxChars) + "..." : text;

        const url =
          "https://wa.me/" + number + "?text=" + encodeURIComponent(sendText);
        window.open(url, "_blank");
      });
    </script>
  </body>
</html>
