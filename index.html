<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Transcrição de Voz - Organização Pessoal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      /* ============================
         ESTILOS GERAIS DA PÁGINA
      ============================ */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
      }

      body {
        background: #0f172a;
        color: #e5e7eb;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .app {
        width: 100%;
        max-width: 520px;
        background: #020617;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        border: 1px solid #1f2937;
      }

      .app h1 {
        font-size: 1.4rem;
        margin-bottom: 6px;
      }

      .app p.sub {
        font-size: 0.9rem;
        color: #9ca3af;
        margin-bottom: 16px;
      }

      .status {
        font-size: 0.85rem;
        margin-bottom: 10px;
      }

      .status-idle {
        color: #9ca3af;
      }

      .status-listening {
        color: #22c55e;
      }

      .status-error {
        color: #f97316;
      }

      .buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      button {
        flex: 1 1 calc(50% - 8px);
        padding: 10px;
        border-radius: 999px;
        border: none;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
      }

      #btnStart {
        background: #22c55e;
        color: #022c22;
      }

      #btnStop {
        background: #ef4444;
        color: #fef2f2;
      }

      #btnCopy {
        background: #0ea5e9;
        color: #e0f2fe;
      }

      #btnSendWhats {
        background: #25d366;
        color: #022c22;
      }

      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      textarea {
        width: 100%;
        min-height: 240px;
        resize: vertical;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid #1f2937;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.95rem;
      }

      .helper {
        font-size: 0.8rem;
        color: #9ca3af;
        margin-top: 8px;
      }

      .warn {
        margin-top: 12px;
        font-size: 0.85rem;
        color: #f97316;
      }
    </style>
  </head>

  <body>
    <div class="app">
      <h1>Transcrição de Voz</h1>
      <p class="sub">Fale e veja o texto aparecer automaticamente.</p>

      <!-- Status da gravação -->
      <div class="status" id="status">
        Status: <span class="status-idle">Parado</span>
      </div>

      <!-- Botões principais -->
      <div class="buttons">
        <button id="btnStart">Iniciar</button>
        <button id="btnStop" disabled>Parar</button>
        <button id="btnCopy">Copiar</button>
        <button id="btnSendWhats">Enviar WhatsApp</button>
      </div>

      <!-- Saída do texto -->
      <textarea
        id="output"
        placeholder="O texto da sua fala aparecerá aqui..."
      ></textarea>

      <p class="helper">
        Dica: fale pausado. Depois organize o texto e envie pro WhatsApp.
      </p>

      <p class="warn" id="warning"></p>
    </div>

    <script>
      // ===============================
      //   ELEMENTOS HTML
      // ===============================
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      const statusEl = document.getElementById("status");
      const warningEl = document.getElementById("warning");
      const outputEl = document.getElementById("output");
      const btnStart = document.getElementById("btnStart");
      const btnStop = document.getElementById("btnStop");
      const btnCopy = document.getElementById("btnCopy");
      const btnSendWhats = document.getElementById("btnSendWhats");

      let recognition = null;
      let finalTranscript = "";

      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = "pt-BR";
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.maxAlternatives = 1;

        // ✅ SOLUÇÃO: reconstrói o texto completo (final + interim) sem duplicar
        recognition.onresult = (event) => {
          let finalText = "";
          let interimText = "";

          // IMPORTANTe:
          // - event.results é uma lista "viva" de tudo que já foi reconhecido nesta sessão
          // - então a forma mais segura é: montar finalText a partir de TODOS os resultados finais
          for (let i = 0; i < event.results.length; i++) {
            const result = event.results[i];
            const text = result[0].transcript;

            if (result.isFinal) {
              // Vai acumulando apenas os trechos finalizados
              finalText += text.trim() + " ";
            } else {
              // O que ainda está "em andamento" (parcial)
              interimText += text;
            }
          }

          // Guarda o final para manter estado (se precisar em outras partes)
          finalTranscript = finalText.trim();

          // Mostra final + parcial (o parcial some quando virar final)
          outputEl.value = (finalText + interimText).trim();
        };
        // Se der erro (sem permissão, etc.)
        recognition.onerror = (event) => {
          statusEl.innerHTML =
            'Status: <span class="status-error">Erro: ' +
            event.error +
            "</span>";
        };

        // Quando o reconhecimento para sozinho
        recognition.onend = () => {
          btnStart.disabled = false;
          btnStop.disabled = true;
          statusEl.innerHTML =
            'Status: <span class="status-idle">Parado</span>';
        };
      }

      // ===============================
      //   INICIAR
      // ===============================
      btnStart.addEventListener("click", () => {
        if (!recognition) return;

        warningEl.textContent = "";
        try {
          recognition.start();
          btnStart.disabled = true;
          btnStop.disabled = false;
          statusEl.innerHTML =
            'Status: <span class="status-listening">Ouvindo...</span>';
        } catch (e) {
          console.error(e);
        }
      });

      // ===============================
      //   PARAR
      // ===============================
      btnStop.addEventListener("click", () => {
        if (!recognition) return;

        recognition.stop();
        btnStart.disabled = false;
        btnStop.disabled = true;

        statusEl.innerHTML = 'Status: <span class="status-idle">Parado</span>';
      });

      // ===============================
      //   COPIAR TEXTO
      // ===============================
      btnCopy.addEventListener("click", async () => {
        const text = outputEl.value.trim();
        if (!text) {
          warningEl.textContent = "Não há texto para copiar.";
          return;
        }

        try {
          await navigator.clipboard.writeText(text);
          warningEl.textContent = "Copiado!";
        } catch {
          warningEl.textContent =
            "Falha ao copiar. Selecione o texto e copie manualmente.";
        }
      });

      // ===============================
      //   ENVIAR PRO WHATSAPP
      // ===============================
      btnSendWhats.addEventListener("click", () => {
        const text = outputEl.value.trim();

        if (!text) {
          warningEl.textContent = "Digite ou grave algo para enviar.";
          return;
        }

        // Pede o número na hora
        let number = prompt(
          "Digite o número de WhatsApp COM DDD (apenas números):\nEx: 199971030409",
        );

        if (!number) {
          warningEl.textContent = "Envio cancelado: nenhum número informado.";
          return;
        }

        // Remove tudo que não é dígito
        number = number.replace(/\D/g, "");

        // Validação simples
        if (number.length < 10) {
          warningEl.textContent =
            "Número inválido. Informe DDD + número (ex: 551199990000).";
          return;
        }

        // Se não começar com 55, assume Brasil e adiciona 55
        if (!number.startsWith("55")) {
          number = "55" + number;
        }

        // Limite para URL (pra não estourar)
        const maxChars = 1500;
        const sendText =
          text.length > maxChars ? text.substring(0, maxChars) + "..." : text;

        const url =
          "https://wa.me/" + number + "?text=" + encodeURIComponent(sendText);

        window.open(url, "_blank");
      });
    </script>
  </body>
</html>
